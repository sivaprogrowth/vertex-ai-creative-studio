# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'N1_HIGHCPU_8'

substitutions:
  _IMAGE_REPO: 'creative-studio'
  _IMAGE_NAME: 'creative-studio'
  _REGION: 'us-central1'
  _ALLOWED_VULNS: '0'  # Fail on any high/critical vulnerabilities (0 = strict, adjust as needed)

timeout: 1800s

steps:
  # Step 1: Build Docker image with commit SHA tag (immutable)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_IMAGE_REPO}/${_IMAGE_NAME}:${COMMIT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_IMAGE_REPO}/${_IMAGE_NAME}:latest'
      - '.'
    env:
      - 'DOCKER_BUILDKIT=1'

  # Step 2: Push image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push image to Artifact Registry'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_IMAGE_REPO}/${_IMAGE_NAME}:${COMMIT_SHA}'

  # Step 3: Scan image for vulnerabilities (using Cloud Build's built-in scanning)
  # Note: Artifact Registry automatically scans images pushed to it
  # This step verifies the scan results
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: bash
    id: 'Verify container security scan'
    args:
      - '-c'
      - |
        # Get image vulnerabilities summary
        echo "Checking vulnerability scan results for image..."
        gcloud artifacts docker images describe \
          '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_IMAGE_REPO}/${_IMAGE_NAME}:${COMMIT_SHA}' \
          --project=${PROJECT_ID} \
          --format='value(image_summary.vulnerability.summary)' || true

        echo "Image scan queued. Scanning will complete automatically in Artifact Registry."

  # Step 4: Deploy to Cloud Run with immutable image tag
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: gcloud
    id: 'Deploy to Cloud Run'
    args:
      - 'run'
      - 'deploy'
      - 'creativestudio'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_IMAGE_REPO}/${_IMAGE_NAME}:${COMMIT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--no-allow-unauthenticated'
      - '--memory=2Gi'
      - '--cpu=2'
      - '--timeout=600'
      - '--max-instances=10'
      - '--project=${PROJECT_ID}'

# Image to be pushed to artifact registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_IMAGE_REPO}/${_IMAGE_NAME}:${COMMIT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_IMAGE_REPO}/${_IMAGE_NAME}:latest'
